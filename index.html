<html>
    <head>
        <meta charset="utf-8">
        <title>Abstractn/rand/</title>
        
        <link rel="stylesheet" type="text/css" href="https://abstractn.github.io/repo/abs.css">
        <script src="https://kit.fontawesome.com/e97eac13ba.js" crossorigin="anonymous"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

        <style>
            #content
            {
                width:300px;
            }
            
            #index
            {
                list-style-type:none;
            }

            .index-elem
            {
                display:block;
                margin:5px 0;
            }

            #index span, #index span a
            {
                width:max-content;
            }

            .index-elem a
            {
                position:relative;
                padding: 0 5px;
                width:max-content;
                color:var(--main-color-b3);
                background-color:var(--main-color-w);
                text-decoration:none;
                border-radius:2px;
                transition-duration:.2s;
                animation-direction: alternate;
                left:0px;
            }
            
            .index-elem a:hover
            {
                color:var(--main-color-w);
                background-color:var(--noixe-color-ar);
                left:5px;
            }

            .index-elem i
            {
                width:20px;
            }
        </style>
    </head>
    
    <body>
        <div id="title" class="flex spaced center">index of: abstractn/rand/</div>
        <div id="content">
            <div id="index">
            </div>
        </div>
        
        <script>

            const _F_DEBUG = true;
            function _LOG(obj)
            { if(_F_DEBUG) { console.log(obj); } }

            function getUnixTimestamp() { return Math.round((new Date()).getTime() / 1000); }

            _LOG( " --- --- --- " + getUnixTimestamp() + " --- --- --- " );

            // #############################################################################

            // check jQuery version to see if it's working
            if(typeof jQuery == 'undefined')
            { console.error("JQuery CDN not working: library not loaded."); }


            const DONE = 4;
            const OK = 200; // status 200 is a successful return.

            function loadIndex(url) // semi-modular function
            {
                _LOG("ajax call");
                var xhr = new XMLHttpRequest();
                xhr.open('GET', url, false); // 'false' makes request sync
                xhr.send(null);

                xhr.onreadystatechange = function ()
                {
                    _LOG("inside xhr.onreadystatechange()");
                    if (xhr.readyState === DONE)
                    {
                        if (xhr.status === OK)
                        {

                            var ignoredFiles=[
                                "README.md",
                                "_config.yml",
                                "index.html"
                            ];
                            var f_ignore=false;
                            var res="";
                            var type="";
                            var icon="";
                            //convertJsonToLi(ulMenu, xhr.responseText);
                            _LOG("parsing JSON");
                            const files = JSON.parse(xhr.responseText);
                            _LOG("returning JSON");
                            console.warn(files);
                            return files;
                        }
                        else
                        { console.error('Ajax error: ' + xhr.status); return "ajax_error"; }
                    }
                };
                _LOG("calling xhr.onreadystatechange()");
                return xhr.onreadystatechange();
            }

            // #####################################################################
            /*
            // structure idea
            var storedIndex =
            {
                expireDate:getUnixTimestap()+60,
                json:ajaxCall(url)
            };
            */
            
            var json;
            var storedIndex = JSON.parse( localStorage.getItem("storedIndex") );
            _LOG("checking LocalStorage:");
            console.log(storedIndex);
            if( storedIndex === null || ( getUnixTimestamp() > storedIndex["expireDate"] ) )
            {
                _LOG("LocalStorage unset - requesting JSON");
                json = loadIndex("https://api.github.com/repos/Abstractn/rand/contents/");
                _LOG("recieved JSON");
                _LOG("about to build index");
                var indexToStore =
                {
                    expireDate:getUnixTimestamp()+60,
                    json:json
                }
                localStorage.setItem("storedIndex",JSON.stringify(indexToStore));
                _LOG("setting LocalStorage");
                console.log(localStorage.getItem("storedIndex"));
                if(json != undefined)
                { buildIndex(json); }
            }
            else
            {
                _LOG("LocalStorage set - reading LocalStorage");
                json = storedIndex["json"];
                buildIndex(json);
            }

            function buildIndex(parsedJSON)
            {
                _LOG("creating index");
                var ignoredFiles=[
                                "README.md",
                                "_config.yml",
                                "index.html",
                                ".gitignore"
                ];
                var f_ignore=false;
                var res="";
                var type="";
                var icon="";
                // const files = JSON.parse(xhr.responseText);
                const files = parsedJSON;
                _LOG("cycling for build and ignored");
                for (let i = 0; i < files.length; i++)
                {
                    // check for files to ignore
                    for(let j=0; j<ignoredFiles.length; j++)
                    {
                        if(files[i].name == ignoredFiles[j])
                        {
                            f_ignore=true;
                            break;
                        }
                    }
                    // if file is not to ignore, parse for folder or file
                    if(!f_ignore)
                    {
                        switch(files[i].type)
                        {
                            case "file": icon='<i class="fas fa-file"></i>'; break;
                            case "dir": icon='<i class="fas fa-folder"></i>'; break;
                            
                            default: null;
                        }
                        res = res + '<span class="index-elem"> <a class="'+files[i].type+'" href="'+files[i].name+'">'+icon+' '+files[i].name+'</a> </span>';
                        f_ignore=false;
                    }
                    f_ignore=false;
                }
                document.getElementById("index").innerHTML = res;
                _LOG("index printed");
            }
        </script>
    </body>
</html>

<!--
    https://api.github.com/repos/Abstractn/rand/contents/
-->